# RCCL warp_speed_v1 Docker Container
#
# To build and run:
#   docker compose -f docker-compose.rccl-warpspeed.yaml up -d
#
# To enter the container:
#   docker compose -f docker-compose.rccl-warpspeed.yaml exec rccl-warpspeed bash
#
# RCCL is installed at: /opt/rccl-warpspeed

services:
  rccl-warpspeed:
    container_name: rccl-warpspeed-rocm70_9-1
    build:
      context: .
      dockerfile: Dockerfile.rocm70_9-1_rccl_warpspeed
    image: rccl-warpspeed:rocm70_9-1-latest
    user: root
    privileged: true
    network_mode: host
    group_add:
      - video
    ipc: host
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
    environment:
      # RCCL warp_speed_v1 environment
      - RCCL_ROOT=/opt/rccl-warpspeed
      - LD_LIBRARY_PATH=/opt/rccl-warpspeed/lib:$LD_LIBRARY_PATH
      - TORCH_NCCL_HIGH_PRIORITY=1
      # Optional: Enable RCCL debugging
      # - NCCL_DEBUG=INFO
      # - NCCL_DEBUG_SUBSYS=INIT,COLL
    volumes:
      # Mount local workspace for development
      - /home/oyazdanb/aorta:/workspace/aorta
      # Mount home directories for data access
      - /home/manrao:/manrao
      - /home/oyazdanb:/home/oyazdanb
    devices:
      - /dev/kfd
      - /dev/dri
    working_dir: /workspace/aorta
    shm_size: 17G
    ulimits:
      memlock: -1
      stack: 67108864
    stdin_open: true
    tty: true
